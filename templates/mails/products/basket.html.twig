{% extends 'mail_base.html.twig' %}
{% import _self as utils %}
{% set basket = data.basket %}
{% block body %}
    {% apply spaceless %}
        {% block details %}
            <h2>Детали заказа</h2>
            <div>
                <div>Итоговая стоимость: {{ utils.show_price_with_discount(basket) }}</div>
                {% if basket.discount.percentage > 0 %}
                    <div>Примененная скидка: {{ basket.discount.percentage }} %</div>
                {% endif %}
                <div>К оплате: {{ basket.discountedPrice.summarizedValue }} р.</div>

            </div>
        {% endblock %}
        {% block internet %}
            {{ utils.show_section(basket, 'Интернет', 'internet_basic', 'additional_internet', ['devices_internet_ont', 'devices_internet_wifi']) }}
        {% endblock %}

        {% block tv %}
            {{ utils.show_section(basket, 'ТВ', 'tv_basic', ['tv_addons', 'tv_theatres'], 'devices_tv_box') }}
        {% endblock %}

        {% if basket.itemsByProductCategoryCode(['additional_phone', 'additional_vision_home', 'additional_vision_parking'])|length > 0 %}
            {% block additional %}
{#                <h2>Дополнительные услуги</h2>#}
                {{ utils.show_section(basket, 'Телефония', 'additional_phone', false, ['devices_additional_phone_dect', 'devices_additional_phone_table']) }}
                {{ utils.show_section(basket, 'Домашнее видеонаблюдение', 'additional_vision_home', false, ['devices_additional_vision_home']) }}
                {{ utils.show_section(basket, 'Видеонаблюдение на парковке', 'additional_vision_parking', 'additional_vision_poe', ['devices_additional_vision_parking']) }}
            {% endblock %}
        {% endif %}
    {% endapply %}
{% endblock %}

{% macro show_price_with_discount(basketItem) %}
    {% if basketItem.discountedPrice.connectionPrice > 0 %}
        {{ basketItem.discountedPrice.connectionPrice|localizedcurrency('RUB') }} +
    {% endif %}
    {% if basketItem.discountedPrice.monthlyPrice != basketItem.price.monthlyPrice  %}
        <s>{{ basketItem.price.monthlyPrice|localizedcurrency('RUB') }}</s>
    {% endif %}
    {{ basketItem.discountedPrice.monthlyPrice|localizedcurrency('RUB') }}/мес.
{% endmacro %}

{% macro show_connection_price(basketItem) %}
    {{ basketItem.discountedPrice.connectionPrice|localizedcurrency('RUB') }}
{% endmacro %}

{% macro show_section(basket, title, plan_cat, additional_cats, devices_cats) %}
    {% set plan =  basket.itemsByProductCategoryCode(plan_cat) %}
    {% if plan is not empty %}
        {% set item = plan|first %}
        <h3>{{title}}</h3>
        <div> Тариф: &laquo;{{ item.product.title }}&raquo; ... <span>{{ utils.show_price_with_discount(item) }}</span></div>

        {% set additional = basket.itemsByProductCategoryCode(additional_cats) %}
        {% if additional is not empty %}
            <h4>Дополнительно</h4>
            <ul>
                {% for item in additional %}
                    <li>&laquo;{{ item.product.title }}&raquo; ... <span>{{ utils.show_price_with_discount(item) }}</span></li>
                {% endfor %}
            </ul>

        {% endif %}

        {% set devices = basket.itemsByProductCategoryCode(devices_cats) %}
        {% if devices is not empty %}
            <h4>Устройства</h4>
            <ul>
                {% for item in devices %}
                    <li>&laquo;{{ item.product.title }}&raquo; &times;{{ item.count }} шт. ... <span>{{ utils.show_connection_price(item) }}</span></li>
                {% endfor %}
            </ul>

        {% endif %}
    {% endif %}
{% endmacro %}